<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML System - Logo Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background-color: #f8f9fa; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .navbar { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card { 
            border: none; 
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.15);
        }
        .progress { 
            height: 25px; 
            background-color: #e9ecef;
        }
        .tab-content {
            background: white;
            padding: 2rem;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .metric-card {
            text-align: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: #f8f9fa;
            margin-bottom: 0.5rem;
        }
        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }
        .metric-label {
            color: #6c757d;
            font-size: 0.85rem;
            font-size: 0.875rem;
        }
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 500;
        }
        .status-running { background-color: #ffc107; color: #000; }
        .status-completed { background-color: #28a745; color: #fff; }
        .status-failed { background-color: #dc3545; color: #fff; }
        .file-drop-area {
            border: 2px dashed #dee2e6;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-drop-area:hover {
            border-color: #667eea;
            background-color: #f8f9fa;
        }
        .file-drop-area.dragover {
            border-color: #667eea;
            background-color: #e9ecef;
        }
        .nav-link.active {
            background-color: #667eea !important;
            border-color: #667eea !important;
        }
        .training-item {
            border-left: 4px solid #667eea;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        .training-item:hover {
            border-left-color: #764ba2;
            transform: translateX(2px);
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-brain"></i> ML System - Logo Detection
            </span>
            <div class="d-flex align-items-center">
                <span class="text-white me-3" id="systemStatus">
                    <i class="fas fa-circle text-success"></i> システム稼働中
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="refreshStatus()">
                    <i class="fas fa-sync-alt"></i> 更新
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- System Status -->
        <div class="row mb-2 mt-3">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="gpuStatus">
                        <i class="fas fa-microchip"></i> --
                    </div>
                    <div class="metric-label">GPU Status</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="cpuUsage">--</div>
                    <div class="metric-label">CPU Usage</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="memoryUsage">--</div>
                    <div class="metric-label">Memory Usage</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="activeTrainings">0</div>
                    <div class="metric-label">Active Trainings</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="mlTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dataset-tab" data-bs-toggle="tab" data-bs-target="#dataset" type="button">
                    <i class="fas fa-database"></i> データセット検証
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="training-tab" data-bs-toggle="tab" data-bs-target="#training" type="button">
                    <i class="fas fa-graduation-cap"></i> トレーニング
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="validation-tab" data-bs-toggle="tab" data-bs-target="#validation" type="button">
                    <i class="fas fa-check-circle"></i> 検証
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="visualization-tab" data-bs-toggle="tab" data-bs-target="#visualization" type="button">
                    <i class="fas fa-chart-line"></i> 可視化
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dataset-management-tab" data-bs-toggle="tab" data-bs-target="#dataset-management" type="button">
                    <i class="fas fa-folder-open"></i> データセット管理
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mlTabContent">
            <!-- Dataset Tab -->
            <div class="tab-pane fade show active" id="dataset" role="tabpanel">
                <h4 class="mb-4">データセット検証</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">データセット選択</h5>
                                <div class="mb-3">
                                    <label class="form-label">既存のデータセット</label>
                                    <select class="form-select" id="datasetSelect">
                                        <option value="">選択してください...</option>
                                    </select>
                                    <small class="text-muted">datasetsフォルダ内のデータセットから選択</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">または、カスタムパスを入力</label>
                                    <input type="text" class="form-control" id="datasetPath" placeholder="/path/to/dataset">
                                    <small class="text-muted">任意の場所のデータセットを指定</small>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="checkImages" checked>
                                    <label class="form-check-label" for="checkImages">
                                        画像ファイルをチェック
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="checkLabels" checked>
                                    <label class="form-check-label" for="checkLabels">
                                        ラベルファイルをチェック
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="validateFormat" checked>
                                    <label class="form-check-label" for="validateFormat">
                                        フォーマットを検証
                                    </label>
                                </div>
                                <button class="btn btn-primary w-100" onclick="validateDataset()">
                                    <i class="fas fa-check"></i> 検証開始
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">検証結果</h5>
                                <div id="datasetValidationResult">
                                    <p class="text-muted">データセットを選択して検証を開始してください。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Training Tab -->
            <div class="tab-pane fade" id="training" role="tabpanel">
                <h4 class="mb-4">モデルトレーニング</h4>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">トレーニング設定</h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">トレーニングモード</label>
                                    <select class="form-select" id="trainingMode">
                                        <option value="full">新規学習</option>
                                        <option value="transfer">転移学習</option>
                                        <option value="continue">継続学習</option>
                                    </select>
                                    <small class="text-muted" id="modeDescription">
                                        最初から新しいモデルを学習します
                                    </small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">データセット</label>
                                    <select class="form-select" id="trainingDataset">
                                        <option value="">選択してください...</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">モデルアーキテクチャ</label>
                                    <select class="form-select" id="modelArchitecture">
                                        <option value="yolov8n">YOLOv8n (最速)</option>
                                        <option value="yolov8s" selected>YOLOv8s (バランス)</option>
                                        <option value="yolov8m">YOLOv8m (高精度)</option>
                                        <option value="yolov8l">YOLOv8l (より高精度)</option>
                                        <option value="yolov8x">YOLOv8x (最高精度)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3" id="baseModelDiv" style="display: none;">
                                    <label class="form-label">ベースモデル</label>
                                    <select class="form-select" id="baseModel">
                                        <option value="">選択してください...</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">エポック数</label>
                                    <input type="number" class="form-control" id="epochs" value="100" min="1" max="1000">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">バッチサイズ</label>
                                    <input type="number" class="form-control" id="batchSize" value="8" min="1" max="128">
                                    <small class="text-muted">CPU環境では8以下を推奨</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">学習率</label>
                                    <input type="number" class="form-control" id="learningRate" value="0.01" min="0.0001" max="0.1" step="0.0001">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">デバイス選択</label>
                                    <select class="form-select" id="trainingDevice">
                                        <option value="">自動選択 (推奨)</option>
                                        <option value="cpu">CPU</option>
                                        <option value="0">GPU 0</option>
                                    </select>
                                    <small class="text-muted" id="deviceInfo">デバイス情報を取得中...</small>
                                </div>
                                
                                <div class="mb-3" id="gpuLoadSection" style="display: none;">
                                    <label class="form-label">GPU負荷率</label>
                                    <input type="range" class="form-range" id="gpuLoadRate" min="0.1" max="1.0" step="0.1" value="0.8">
                                    <small class="text-muted">現在: <span id="gpuLoadRateValue">0.8</span></small>
                                </div>
                                
                                <button class="btn btn-primary w-100" onclick="startTraining()">
                                    <i class="fas fa-play"></i> トレーニング開始
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">トレーニング状況</h5>
                                <div id="trainingStatus">
                                    <p class="text-muted">トレーニングが開始されていません。</p>
                                </div>
                                
                                <h6 class="mt-4">アクティブなトレーニング</h6>
                                <div id="activeTrainingsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Validation Tab -->
            <div class="tab-pane fade" id="validation" role="tabpanel">
                <h4 class="mb-4">モデル検証</h4>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">検証設定</h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">モデル選択</label>
                                    <select class="form-select" id="validationModel">
                                        <option value="">選択してください...</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">テストデータセット</label>
                                    <input type="text" class="form-control" id="testDatasetPath" placeholder="/path/to/test/dataset">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">信頼度しきい値</label>
                                    <input type="number" class="form-control" id="confidenceThreshold" value="0.25" min="0" max="1" step="0.05">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">IoUしきい値</label>
                                    <input type="number" class="form-control" id="iouThreshold" value="0.45" min="0" max="1" step="0.05">
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="savePredictions" checked>
                                    <label class="form-check-label" for="savePredictions">
                                        予測結果を保存
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="analyzeErrors" checked>
                                    <label class="form-check-label" for="analyzeErrors">
                                        エラー分析を実行
                                    </label>
                                </div>
                                
                                <button class="btn btn-primary w-100" onclick="validateModel()">
                                    <i class="fas fa-check-circle"></i> 検証開始
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">検証結果</h5>
                                <div id="validationResult">
                                    <p class="text-muted">モデルを選択して検証を開始してください。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualization Tab -->
            <div class="tab-pane fade" id="visualization" role="tabpanel">
                <h4 class="mb-4">モデル可視化</h4>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">可視化設定</h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">モデル選択</label>
                                    <select class="form-select" id="visualizationModel">
                                        <option value="">選択してください...</option>
                                    </select>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="includeConfusionMatrix" checked>
                                    <label class="form-check-label" for="includeConfusionMatrix">
                                        混同行列
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="includePRCurve" checked>
                                    <label class="form-check-label" for="includePRCurve">
                                        PR曲線
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="includeF1Curve" checked>
                                    <label class="form-check-label" for="includeF1Curve">
                                        F1曲線
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="includeTrainingHistory" checked>
                                    <label class="form-check-label" for="includeTrainingHistory">
                                        トレーニング履歴
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="includeClassMetrics" checked>
                                    <label class="form-check-label" for="includeClassMetrics">
                                        クラス別メトリクス
                                    </label>
                                </div>
                                
                                <button class="btn btn-primary w-100" onclick="visualizeModel()">
                                    <i class="fas fa-chart-line"></i> 可視化開始
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">可視化結果</h5>
                                <div id="visualizationResult">
                                    <p class="text-muted">モデルを選択して可視化を開始してください。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dataset Management Tab -->
            <div class="tab-pane fade" id="dataset-management" role="tabpanel">
                <h4 class="mb-4">データセット管理</h4>
                
                <!-- データセットスプリットエリア -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-split"></i> 画像データスプリット</h5>
                    </div>
                    <div class="card-body">
                        <form id="datasetSplitForm">
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label class="form-label">ベースパス <small class="text-muted">(オプション)</small></label>
                                        <input type="text" class="form-control" id="basePath" 
                                               value="/mnt/c/02_yolo_projects" placeholder="/mnt/c/02_yolo_projects">
                                        <small class="text-muted">デフォルト: /mnt/c/02_yolo_projects</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">クラス名</label>
                                        <input type="text" class="form-control" id="className" 
                                               placeholder="例: BANDAI" required>
                                        <small class="text-muted">画像は {ベースパス}/{クラス名}/images にあることを確認してください</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">コピー先データセット</label>
                                        <div class="input-group">
                                            <select class="form-select" id="destinationDataset" onchange="toggleNewDatasetInput()">
                                                <option value="">既存のデータセットを選択...</option>
                                                <option value="__new__">新規データセットを作成</option>
                                            </select>
                                            <input type="text" class="form-control" id="newDatasetName" 
                                                   placeholder="新規データセット名" style="display: none;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">処理する画像枚数 <small class="text-muted">(オプション)</small></label>
                                        <input type="number" class="form-control" id="maxImages" 
                                               placeholder="未入力時は全件処理" min="1">
                                        <small class="text-muted">例: 100と入力すると100枚をランダムに選択して処理します</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Train比率</label>
                                        <input type="number" class="form-control" id="trainRatio" 
                                               value="0.69" min="0" max="1" step="0.01" onchange="updateRatioSum()">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Validation比率</label>
                                        <input type="number" class="form-control" id="valRatio" 
                                               value="0.17" min="0" max="1" step="0.01" onchange="updateRatioSum()">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Test比率</label>
                                        <input type="number" class="form-control" id="testRatio" 
                                               value="0.14" min="0" max="1" step="0.01" onchange="updateRatioSum()">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">ランダムシード</label>
                                        <input type="number" class="form-control" id="randomSeed" value="42" min="0">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <small class="text-muted">合計: <span id="ratioSum" class="fw-bold">1.00</span></small>
                                <span id="ratioError" class="text-danger ms-2" style="display: none;">
                                    合計が1.0になるように調整してください
                                </span>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" id="splitButton">
                                <i class="fas fa-play"></i> スプリット実行
                            </button>
                        </form>
                        
                        <!-- 実行結果表示エリア -->
                        <div id="splitResultArea" class="mt-4" style="display: none;">
                            <div class="alert alert-info">
                                <h6 class="alert-heading">スプリット処理状況</h6>
                                <div id="splitResult"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- クラス削除エリア -->
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-trash-alt"></i> クラス別一括削除</h5>
                    </div>
                    <div class="card-body">
                        <form id="classDeleteForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">削除対象データセット</label>
                                        <select class="form-select" id="deleteDataset" required>
                                            <option value="">データセットを選択...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">削除するクラス名</label>
                                        <input type="text" class="form-control" id="deleteClassName" 
                                               placeholder="クラス名を入力" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="confirmDelete">
                                <label class="form-check-label text-danger" for="confirmDelete">
                                    削除を実行することを確認しました
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-danger" id="deleteButton">
                                <i class="fas fa-trash"></i> 削除実行
                            </button>
                        </form>
                        
                        <!-- 削除結果表示エリア -->
                        <div id="deleteResultArea" class="mt-4" style="display: none;">
                            <div class="alert alert-warning">
                                <h6 class="alert-heading">削除結果</h6>
                                <div id="deleteResult"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- データセット削除エリア -->
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> データセット削除</h5>
                    </div>
                    <div class="card-body">
                        <form id="datasetDeleteForm">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label">削除するデータセット</label>
                                        <select class="form-select" id="deleteFullDataset" required>
                                            <option value="">データセットを選択...</option>
                                        </select>
                                        <small class="text-muted">選択したデータセット全体が削除されます</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle"></i> <strong>警告:</strong> この操作は取り消せません。データセット内のすべてのファイルが削除されます。
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="confirmFullDelete">
                                <label class="form-check-label text-danger" for="confirmFullDelete">
                                    データセット全体を削除することを確認しました
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-dark" id="deleteFullButton">
                                <i class="fas fa-skull-crossbones"></i> データセットを削除
                            </button>
                        </form>
                        
                        <!-- 削除結果表示エリア -->
                        <div id="deleteFullResultArea" class="mt-4" style="display: none;">
                            <div class="alert alert-info">
                                <h6 class="alert-heading">削除結果</h6>
                                <div id="deleteFullResult"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let systemStatusInterval;
        let activeTrainings = new Map();
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            loadDatasets();
            loadModels();
            
            // Start periodic refresh
            systemStatusInterval = setInterval(refreshStatus, 5000);
            
            // Setup event listeners
            document.getElementById('trainingMode').addEventListener('change', function() {
                const mode = this.value;
                const baseModelDiv = document.getElementById('baseModelDiv');
                const modeDescription = document.getElementById('modeDescription');
                const baseModelLabel = baseModelDiv.querySelector('label');
                
                switch(mode) {
                    case 'full':
                        baseModelDiv.style.display = 'none';
                        modeDescription.textContent = '最初から新しいモデルを学習します';
                        break;
                    case 'transfer':
                        baseModelDiv.style.display = 'block';
                        baseModelLabel.textContent = 'ベースモデル (オプション)';
                        modeDescription.textContent = '事前学習済みモデルを新しいデータセット・クラスで再学習します';
                        break;
                    case 'continue':
                        baseModelDiv.style.display = 'block';
                        baseModelLabel.textContent = 'ベースモデル (必須)';
                        modeDescription.textContent = '中断したトレーニングを再開、または既存モデルをさらに学習します';
                        break;
                }
            });
            
            document.getElementById('gpuLoadRate').addEventListener('input', function() {
                document.getElementById('gpuLoadRateValue').textContent = this.value;
            });
            
            // デバイス選択の変更を監視
            document.getElementById('trainingDevice').addEventListener('change', function() {
                const device = this.value;
                const gpuLoadSection = document.getElementById('gpuLoadSection');
                
                // GPUが選択された場合のみGPU負荷率を表示
                if (device && device !== 'cpu') {
                    gpuLoadSection.style.display = 'block';
                } else {
                    gpuLoadSection.style.display = 'none';
                }
            });
        });
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toastEl = document.getElementById('liveToast');
            const toast = new bootstrap.Toast(toastEl);
            const toastBody = document.getElementById('toastMessage');
            
            toastBody.textContent = message;
            toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
            
            switch(type) {
                case 'success': toastEl.classList.add('bg-success'); break;
                case 'error': toastEl.classList.add('bg-danger'); break;
                case 'warning': toastEl.classList.add('bg-warning'); break;
                default: toastEl.classList.add('bg-info');
            }
            
            toast.show();
        }
        
        // Refresh system status
        async function refreshStatus() {
            try {
                const response = await fetch('/api/v1/ml/status');
                const data = await response.json();
                
                // Update GPU status
                if (data.gpu_available) {
                    document.getElementById('gpuStatus').innerHTML = 
                        `<i class="fas fa-microchip text-success"></i> GPU`;
                    // Update device info
                    const gpuName = data.gpu_info?.gpu_name || 'GPU Available';
                    const gpuMemory = data.gpu_info?.gpu_memory ? `${(data.gpu_info.gpu_memory / 1024).toFixed(1)} GB` : '';
                    document.getElementById('deviceInfo').textContent = 
                        `${gpuName}${gpuMemory ? ' (' + gpuMemory + ')' : ''} が検出されました`;
                } else {
                    document.getElementById('gpuStatus').innerHTML = 
                        `<i class="fas fa-microchip text-warning"></i> CPU`;
                    // Update device info
                    document.getElementById('deviceInfo').textContent = 
                        'GPUが検出されませんでした。CPUモードで実行されます';
                }
                
                // Update metrics
                document.getElementById('cpuUsage').textContent = `${data.cpu_usage.toFixed(1)}%`;
                document.getElementById('memoryUsage').textContent = `${data.memory_usage.toFixed(1)}%`;
                document.getElementById('activeTrainings').textContent = data.active_trainings.length;
                
                // Update active trainings
                if (data.active_trainings.length > 0) {
                    updateActiveTrainings();
                }
                
            } catch (error) {
                console.error('Failed to refresh status:', error);
            }
        }
        
        // Load available datasets
        async function loadDatasets() {
            try {
                const response = await fetch('/api/v1/dataset/list');
                const datasets = await response.json();
                
                // Update dataset selects
                const selects = ['datasetSelect', 'trainingDataset'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">選択してください...</option>';
                        
                        datasets.forEach(dataset => {
                            const option = document.createElement('option');
                            option.value = dataset.name;  // nameのみを使用
                            option.textContent = dataset.name;
                            select.appendChild(option);
                        });
                    }
                });
                
            } catch (error) {
                console.error('Failed to load datasets:', error);
            }
        }
        
        // Load available models
        async function loadModels() {
            try {
                const response = await fetch('/api/v1/ml/models');
                const models = await response.json();
                
                // Update model selects
                const selects = ['baseModel', 'validationModel', 'visualizationModel'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">選択してください...</option>';
                    
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.path;
                        option.textContent = `${model.name} (${model.project})`;
                        select.appendChild(option);
                    });
                });
                
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        }
        
        // Validate dataset
        async function validateDataset() {
            const datasetName = document.getElementById('datasetSelect').value;
            const customPath = document.getElementById('datasetPath').value;
            
            let datasetPath = '';
            if (datasetName) {
                // datasetsディレクトリ内のデータセットを使用
                datasetPath = `/root/projects/logo-detection-api/datasets/${datasetName}`;
            } else if (customPath) {
                // カスタムパスを使用
                datasetPath = customPath;
            } else {
                showToast('データセットを選択してください', 'warning');
                return;
            }
            
            const request = {
                dataset_path: datasetPath,
                check_images: document.getElementById('checkImages').checked,
                check_labels: document.getElementById('checkLabels').checked,
                validate_format: document.getElementById('validateFormat').checked
            };
            
            console.log('Validating dataset:', request);
            
            try {
                const response = await fetch('/api/v1/ml/dataset/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(request)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'データセット検証に失敗しました');
                }
                
                const result = await response.json();
                displayDatasetValidationResult(result);
                
                if (result.valid) {
                    showToast('データセット検証が完了しました', 'success');
                } else {
                    showToast('データセットに問題が見つかりました', 'warning');
                }
                
            } catch (error) {
                console.error('Dataset validation failed:', error);
                document.getElementById('datasetValidationResult').innerHTML = 
                    `<div class="alert alert-danger">エラー: ${error.message}</div>`;
                showToast('データセット検証に失敗しました', 'error');
            }
        }
        
        // Display dataset validation result
        function displayDatasetValidationResult(result) {
            const container = document.getElementById('datasetValidationResult');
            
            let html = `
                <div class="alert ${result.valid ? 'alert-success' : 'alert-warning'}">
                    <strong>検証結果:</strong> ${result.valid ? '✅ 有効' : '⚠️ 無効'}
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="metric-card">
                            <div class="metric-value">${result.total_images}</div>
                            <div class="metric-label">総画像数</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card">
                            <div class="metric-value">${result.total_labels}</div>
                            <div class="metric-label">総ラベル数</div>
                        </div>
                    </div>
                </div>
                
                <h6>クラス分布:</h6>
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>クラス</th>
                            <th>Train</th>
                            <th>Val</th>
                            <th>Test</th>
                            <th>合計</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (result.classes && result.classes.length > 0) {
                result.classes.forEach(className => {
                    const trainCount = result.class_distribution?.train?.[className] || 0;
                    const valCount = result.class_distribution?.val?.[className] || 0;
                    const testCount = result.class_distribution?.test?.[className] || 0;
                    const total = trainCount + valCount + testCount;
                    
                    html += `<tr>
                        <td><strong>${className}</strong></td>
                        <td>${trainCount}</td>
                        <td>${valCount}</td>
                        <td>${testCount}</td>
                        <td><strong>${total}</strong></td>
                    </tr>`;
                });
            } else {
                html += '<tr><td colspan="5" class="text-center text-muted">クラス情報がありません</td></tr>';
            }
            
            html += '</tbody></table>';
            
            if (result.errors.length > 0) {
                html += '<h6 class="text-danger">エラー:</h6><ul class="text-danger">';
                result.errors.forEach(error => {
                    html += `<li>${error}</li>`;
                });
                html += '</ul>';
            }
            
            if (result.warnings.length > 0) {
                html += '<h6 class="text-warning">警告:</h6><ul class="text-warning">';
                result.warnings.forEach(warning => {
                    html += `<li>${warning}</li>`;
                });
                html += '</ul>';
            }
            
            container.innerHTML = html;
        }
        
        // Start training
        async function startTraining() {
            const datasetName = document.getElementById('trainingDataset').value;
            if (!datasetName) {
                showToast('データセットを選択してください', 'warning');
                return;
            }
            
            const mode = document.getElementById('trainingMode').value;
            const device = document.getElementById('trainingDevice').value;
            
            // データセット名から完全なパスを構築
            const datasetPath = `/root/projects/logo-detection-api/datasets/${datasetName}`;
            
            const request = {
                mode: mode,
                dataset_path: datasetPath,
                model_architecture: document.getElementById('modelArchitecture').value,
                epochs: parseInt(document.getElementById('epochs').value),
                batch_size: parseInt(document.getElementById('batchSize').value),
                learning_rate: parseFloat(document.getElementById('learningRate').value)
            };
            
            // デバイスが選択されている場合は追加
            if (device) {
                request.device = device;
            }
            
            if (mode === 'transfer') {
                const baseModel = document.getElementById('baseModel').value;
                if (baseModel) {
                    request.base_model_path = baseModel;
                }
                // 転移学習では、ベースモデルはオプション（指定しない場合はプリトレーンドモデル使用）
            } else if (mode === 'continue') {
                const baseModel = document.getElementById('baseModel').value;
                if (!baseModel) {
                    showToast('継続学習にはベースモデルの選択が必須です', 'warning');
                    return;
                }
                request.base_model_path = baseModel;
            }
            
            try {
                const response = await fetch('/api/v1/ml/training/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(request)
                });
                
                const result = await response.json();
                showToast('トレーニングを開始しました', 'success');
                
                // Start monitoring this training
                monitorTraining(result.training_id);
                
            } catch (error) {
                console.error('Failed to start training:', error);
                showToast('トレーニングの開始に失敗しました', 'error');
            }
        }
        
        // Monitor training progress
        async function monitorTraining(trainingId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/v1/ml/training/status/${trainingId}`);
                    const status = await response.json();
                    
                    activeTrainings.set(trainingId, status);
                    updateActiveTrainings();
                    
                    if (status.status === 'completed' || status.status === 'failed') {
                        clearInterval(interval);
                        activeTrainings.delete(trainingId);
                        
                        if (status.status === 'completed') {
                            showToast('トレーニングが完了しました', 'success');
                            loadModels(); // Refresh model list
                        } else {
                            showToast('トレーニングが失敗しました', 'error');
                        }
                    }
                    
                } catch (error) {
                    console.error('Failed to get training status:', error);
                    clearInterval(interval);
                }
            }, 2000);
        }
        
        // Update active trainings display
        function updateActiveTrainings() {
            const container = document.getElementById('activeTrainingsList');
            const trainingStatusDiv = document.getElementById('trainingStatus');
            
            if (activeTrainings.size === 0) {
                container.innerHTML = '<p class="text-muted">アクティブなトレーニングはありません。</p>';
                trainingStatusDiv.innerHTML = '<p class="text-muted">トレーニングが開始されていません。</p>';
                return;
            }
            
            let html = '';
            let statusHtml = '';
            
            activeTrainings.forEach((status, id) => {
                const progress = status.progress || 0;
                
                html += `
                    <div class="card training-item">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">${status.mode} - ${id.substring(0, 8)}</h6>
                                <span class="status-badge status-${status.status}">${status.status}</span>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     style="width: ${progress}%">${progress.toFixed(1)}%</div>
                            </div>
                            <small class="text-muted">
                                Epoch: ${status.current_epoch}/${status.total_epochs}
                            </small>
                        </div>
                    </div>
                `;
                
                if (status.status === 'running') {
                    statusHtml = `
                        <div class="alert alert-info">
                            <h6>トレーニング中: ${id.substring(0, 8)}</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     style="width: ${progress}%">${progress.toFixed(1)}%</div>
                            </div>
                            <p class="mb-1">Epoch: ${status.current_epoch}/${status.total_epochs}</p>
                            ${status.current_metrics ? `
                                <small>
                                    Loss: ${status.current_metrics.loss?.toFixed(4) || '--'} | 
                                    Box Loss: ${status.current_metrics.box_loss?.toFixed(4) || '--'} | 
                                    Cls Loss: ${status.current_metrics.cls_loss?.toFixed(4) || '--'}
                                </small>
                            ` : ''}
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
            if (statusHtml) {
                trainingStatusDiv.innerHTML = statusHtml;
            }
        }
        
        // Validate model
        async function validateModel() {
            const modelPath = document.getElementById('validationModel').value;
            const testDatasetPath = document.getElementById('testDatasetPath').value;
            
            if (!modelPath) {
                showToast('モデルを選択してください', 'warning');
                return;
            }
            
            if (!testDatasetPath) {
                showToast('テストデータセットのパスを入力してください', 'warning');
                return;
            }
            
            const request = {
                model_path: modelPath,
                test_dataset_path: testDatasetPath,
                confidence_threshold: parseFloat(document.getElementById('confidenceThreshold').value),
                iou_threshold: parseFloat(document.getElementById('iouThreshold').value),
                save_predictions: document.getElementById('savePredictions').checked,
                analyze_errors: document.getElementById('analyzeErrors').checked
            };
            
            showToast('検証を開始しました。しばらくお待ちください...', 'info');
            
            try {
                const response = await fetch('/api/v1/ml/model/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(request)
                });
                
                const result = await response.json();
                displayValidationResult(result);
                showToast('モデル検証が完了しました', 'success');
                
            } catch (error) {
                console.error('Model validation failed:', error);
                showToast('モデル検証に失敗しました', 'error');
            }
        }
        
        // Display validation result
        function displayValidationResult(result) {
            const container = document.getElementById('validationResult');
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-value">${(result.accuracy * 100).toFixed(1)}%</div>
                            <div class="metric-label">Accuracy</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-value">${result.f1_score.toFixed(3)}</div>
                            <div class="metric-label">F1 Score</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-value">${result.precision.toFixed(3)}</div>
                            <div class="metric-label">Precision</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-value">${result.recall.toFixed(3)}</div>
                            <div class="metric-label">Recall</div>
                        </div>
                    </div>
                </div>
                
                <h6 class="mt-4">処理情報:</h6>
                <ul>
                    <li>総画像数: ${result.total_images}</li>
                    <li>正解数: ${result.correct_predictions}</li>
                    <li>処理時間: ${result.processing_time.toFixed(2)}秒</li>
                </ul>
            `;
            
            if (result.class_metrics && Object.keys(result.class_metrics).length > 0) {
                html += '<h6 class="mt-4">クラス別メトリクス:</h6>';
                html += '<table class="table table-sm"><thead><tr>';
                html += '<th>クラス</th><th>Precision</th><th>Recall</th><th>F1</th>';
                html += '</tr></thead><tbody>';
                
                for (const [className, metrics] of Object.entries(result.class_metrics)) {
                    html += `<tr>
                        <td>${className}</td>
                        <td>${metrics.precision.toFixed(3)}</td>
                        <td>${metrics.recall.toFixed(3)}</td>
                        <td>${metrics.f1_score.toFixed(3)}</td>
                    </tr>`;
                }
                
                html += '</tbody></table>';
            }
            
            container.innerHTML = html;
        }
        
        // Visualize model
        async function visualizeModel() {
            const modelPath = document.getElementById('visualizationModel').value;
            
            if (!modelPath) {
                showToast('モデルを選択してください', 'warning');
                return;
            }
            
            const request = {
                model_path: modelPath,
                include_confusion_matrix: document.getElementById('includeConfusionMatrix').checked,
                include_pr_curve: document.getElementById('includePRCurve').checked,
                include_f1_curve: document.getElementById('includeF1Curve').checked,
                include_training_history: document.getElementById('includeTrainingHistory').checked,
                include_class_metrics: document.getElementById('includeClassMetrics').checked
            };
            
            showToast('可視化を開始しました...', 'info');
            
            try {
                const response = await fetch('/api/v1/ml/model/visualize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(request)
                });
                
                const result = await response.json();
                displayVisualizationResult(result);
                showToast('モデル可視化が完了しました', 'success');
                
            } catch (error) {
                console.error('Model visualization failed:', error);
                showToast('モデル可視化に失敗しました', 'error');
            }
        }
        
        // Display visualization result
        function displayVisualizationResult(result) {
            const container = document.getElementById('visualizationResult');
            
            let html = '<h6>モデル情報:</h6>';
            html += '<ul>';
            html += `<li>パス: ${result.model_path}</li>`;
            html += `<li>サイズ: ${result.model_info.size?.toFixed(2) || '--'} MB</li>`;
            html += `<li>クラス数: ${result.model_info.num_classes || '--'}</li>`;
            html += '</ul>';
            
            if (result.training_history) {
                html += '<h6 class="mt-4">トレーニング履歴:</h6>';
                html += '<div class="chart-container"><canvas id="trainingChart"></canvas></div>';
            }
            
            container.innerHTML = html;
            
            // Draw training chart if available
            if (result.training_history) {
                setTimeout(() => {
                    const ctx = document.getElementById('trainingChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: result.training_history.epoch || [],
                            datasets: [
                                {
                                    label: 'mAP@0.5',
                                    data: result.training_history.mAP50 || [],
                                    borderColor: 'rgb(75, 192, 192)',
                                    tension: 0.1
                                },
                                {
                                    label: 'Precision',
                                    data: result.training_history.precision || [],
                                    borderColor: 'rgb(255, 99, 132)',
                                    tension: 0.1
                                },
                                {
                                    label: 'Recall',
                                    data: result.training_history.recall || [],
                                    borderColor: 'rgb(54, 162, 235)',
                                    tension: 0.1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 1
                                }
                            }
                        }
                    });
                }, 100);
            }
        }
        
        // ========== Dataset Management Functions ==========
        
        // Toggle new dataset input
        function toggleNewDatasetInput() {
            const select = document.getElementById('destinationDataset');
            const newInput = document.getElementById('newDatasetName');
            
            if (select.value === '__new__') {
                newInput.style.display = 'block';
                newInput.required = true;
                // Hide the select
                select.style.display = 'none';
                
                // Add a back button
                if (!document.getElementById('backToSelect')) {
                    const backBtn = document.createElement('button');
                    backBtn.id = 'backToSelect';
                    backBtn.type = 'button';
                    backBtn.className = 'btn btn-sm btn-secondary mt-2';
                    backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> 戻る';
                    backBtn.onclick = function() {
                        select.style.display = 'block';
                        select.value = '';
                        newInput.style.display = 'none';
                        newInput.value = '';
                        newInput.required = false;
                        this.remove();
                    };
                    newInput.parentNode.appendChild(backBtn);
                }
            } else {
                newInput.style.display = 'none';
                newInput.required = false;
                newInput.value = '';
            }
        }
        
        // Update ratio sum
        function updateRatioSum() {
            const trainRatio = parseFloat(document.getElementById('trainRatio').value) || 0;
            const valRatio = parseFloat(document.getElementById('valRatio').value) || 0;
            const testRatio = parseFloat(document.getElementById('testRatio').value) || 0;
            
            const sum = trainRatio + valRatio + testRatio;
            document.getElementById('ratioSum').textContent = sum.toFixed(2);
            
            const errorSpan = document.getElementById('ratioError');
            const splitButton = document.getElementById('splitButton');
            
            if (Math.abs(sum - 1.0) > 0.001) {
                errorSpan.style.display = 'inline';
                splitButton.disabled = true;
            } else {
                errorSpan.style.display = 'none';
                splitButton.disabled = false;
            }
        }
        
        // Load datasets for dropdown
        async function loadDatasetsForManagement() {
            try {
                const response = await fetch('/api/v1/dataset/list');
                const datasets = await response.json();
                
                const destinationSelect = document.getElementById('destinationDataset');
                const deleteSelect = document.getElementById('deleteDataset');
                const deleteFullSelect = document.getElementById('deleteFullDataset');
                
                // Clear existing options
                destinationSelect.innerHTML = '<option value="">既存のデータセットを選択...</option>';
                destinationSelect.innerHTML += '<option value="__new__">新規データセットを作成</option>';
                deleteSelect.innerHTML = '<option value="">データセットを選択...</option>';
                deleteFullSelect.innerHTML = '<option value="">データセットを選択...</option>';
                
                // Add dataset options
                datasets.forEach(dataset => {
                    destinationSelect.innerHTML += `<option value="${dataset.name}">${dataset.name}</option>`;
                    deleteSelect.innerHTML += `<option value="${dataset.name}">${dataset.name}</option>`;
                    deleteFullSelect.innerHTML += `<option value="${dataset.name}">${dataset.name}</option>`;
                });
            } catch (error) {
                console.error('Failed to load datasets:', error);
            }
        }
        
        // Dataset split form submission
        document.getElementById('datasetSplitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const className = document.getElementById('className').value.trim();
            const basePath = document.getElementById('basePath').value.trim() || '/mnt/c/02_yolo_projects';
            const maxImages = document.getElementById('maxImages').value.trim();
            
            const formData = {
                class_name: className,
                base_path: basePath,
                destination_dataset: document.getElementById('destinationDataset').value,
                train_ratio: parseFloat(document.getElementById('trainRatio').value),
                val_ratio: parseFloat(document.getElementById('valRatio').value),
                test_ratio: parseFloat(document.getElementById('testRatio').value),
                random_seed: parseInt(document.getElementById('randomSeed').value)
            };
            
            // Add max_images if specified
            if (maxImages) {
                formData.max_images = parseInt(maxImages);
            }
            
            // Handle new dataset creation
            if (formData.destination_dataset === '__new__') {
                formData.destination_dataset = document.getElementById('newDatasetName').value;
                formData.create_new = true;
            }
            
            console.log('Sending split request:', formData);
            
            const resultArea = document.getElementById('splitResultArea');
            const resultDiv = document.getElementById('splitResult');
            
            resultArea.style.display = 'block';
            
            // 処理開始メッセージ
            resultDiv.innerHTML = `
                <div class="mb-2">📁 データセット準備中...</div>
                <div class="mb-2 text-muted">画像ファイルを検索しています...</div>
            `;
            
            try {
                const response = await fetch('/api/v1/dataset/split', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    let errorDetail = 'スプリット処理に失敗しました';
                    try {
                        const error = await response.json();
                        errorDetail = error.detail || errorDetail;
                    } catch (e) {
                        errorDetail = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorDetail);
                }
                
                const result = await response.json();
                
                // Display results
                resultDiv.innerHTML = `
                    <div class="text-success fw-bold mb-3">✅ スプリット完了！</div>
                    <div class="mb-2">
                        <strong>📂 Train フォルダ:</strong> ${result.train_count}件コピー済み
                        <span class="text-muted">(${result.train_percentage.toFixed(1)}%)</span>
                    </div>
                    <div class="mb-2">
                        <strong>📂 Validation フォルダ:</strong> ${result.val_count}件コピー済み
                        <span class="text-muted">(${result.val_percentage.toFixed(1)}%)</span>
                    </div>
                    <div class="mb-2">
                        <strong>📂 Test フォルダ:</strong> ${result.test_count}件コピー済み
                        <span class="text-muted">(${result.test_percentage.toFixed(1)}%)</span>
                    </div>
                    ${result.skipped_count > 0 ? `
                        <div class="mb-2 text-warning">
                            ⚠️ スキップ: ${result.skipped_count}件 (既存ファイルとの重複)
                        </div>
                    ` : ''}
                    <hr>
                    <div class="fw-bold">📊 合計処理数: ${result.total_processed}件</div>
                `;
                
                showToast('データセットスプリットが完了しました', 'success');
                
                // Reload datasets
                loadDatasetsForManagement();
                loadDatasets(); // Also update main dataset list
            } catch (error) {
                console.error('Failed to split dataset:', error);
                resultDiv.innerHTML = `
                    <div class="text-danger fw-bold mb-2">❌ エラーが発生しました</div>
                    <div class="text-danger">${error.message}</div>
                `;
                showToast('スプリット処理に失敗しました', 'error');
            }
        });
        
        // Class delete form submission
        document.getElementById('classDeleteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const deleteButton = document.getElementById('deleteButton');
            const confirmCheckbox = document.getElementById('confirmDelete');
            
            if (!confirmCheckbox.checked) {
                showToast('削除を実行するには確認チェックボックスをチェックしてください', 'warning');
                return;
            }
            
            const dataset = document.getElementById('deleteDataset').value;
            const className = document.getElementById('deleteClassName').value;
            
            if (!confirm(`データセット "${dataset}" から クラス "${className}" を削除しますか？\nこの操作は取り消せません。`)) {
                return;
            }
            
            deleteButton.disabled = true;
            deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 削除中...';
            
            const resultArea = document.getElementById('deleteResultArea');
            const resultDiv = document.getElementById('deleteResult');
            
            resultArea.style.display = 'block';
            resultDiv.innerHTML = '削除処理を実行しています...';
            
            try {
                const response = await fetch('/api/v1/dataset/delete-class', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dataset_name: dataset,
                        class_name: className
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '削除処理に失敗しました');
                }
                
                const result = await response.json();
                
                // Display results
                resultDiv.innerHTML = `
                    <div class="text-danger fw-bold mb-2">削除完了！</div>
                    <div>Train: ${result.train_deleted}件削除</div>
                    <div>Validation: ${result.val_deleted}件削除</div>
                    <div>Test: ${result.test_deleted}件削除</div>
                    <div class="fw-bold mt-2">合計削除: ${result.total_deleted}件</div>
                `;
                
                showToast('クラスの削除が完了しました', 'success');
                
                // Reset form
                document.getElementById('classDeleteForm').reset();
                confirmCheckbox.checked = false;
            } catch (error) {
                console.error('Failed to delete class:', error);
                resultDiv.innerHTML = `<div class="text-danger">エラー: ${error.message}</div>`;
                showToast('削除処理に失敗しました', 'error');
            } finally {
                deleteButton.disabled = false;
                deleteButton.innerHTML = '<i class="fas fa-trash"></i> 削除実行';
            }
        });
        
        // Dataset delete form submission
        document.getElementById('datasetDeleteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const deleteButton = document.getElementById('deleteFullButton');
            const confirmCheckbox = document.getElementById('confirmFullDelete');
            
            if (!confirmCheckbox.checked) {
                showToast('削除を実行するには確認チェックボックスをチェックしてください', 'warning');
                return;
            }
            
            const dataset = document.getElementById('deleteFullDataset').value;
            
            if (!confirm(`データセット "${dataset}" を完全に削除しますか？\nこの操作は取り消せません。`)) {
                return;
            }
            
            deleteButton.disabled = true;
            deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 削除中...';
            
            const resultArea = document.getElementById('deleteFullResultArea');
            const resultDiv = document.getElementById('deleteFullResult');
            
            resultArea.style.display = 'block';
            resultDiv.innerHTML = '削除処理を実行しています...';
            
            try {
                const response = await fetch('/api/v1/dataset/delete-dataset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dataset_name: dataset,
                        confirm: true
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'データセット削除に失敗しました');
                }
                
                const result = await response.json();
                
                // Display results
                resultDiv.innerHTML = `
                    <div class="text-success fw-bold mb-2">削除完了！</div>
                    <div>${result.message}</div>
                    <div class="text-muted mt-2">削除されたパス: ${result.deleted_path}</div>
                `;
                
                showToast('データセットの削除が完了しました', 'success');
                
                // Reload datasets
                loadDatasetsForManagement();
                loadDatasets();
                
                // Reset form
                document.getElementById('datasetDeleteForm').reset();
                confirmCheckbox.checked = false;
            } catch (error) {
                console.error('Failed to delete dataset:', error);
                resultDiv.innerHTML = `<div class="text-danger">エラー: ${error.message}</div>`;
                showToast('データセット削除に失敗しました', 'error');
            } finally {
                deleteButton.disabled = false;
                deleteButton.innerHTML = '<i class="fas fa-skull-crossbones"></i> データセットを削除';
            }
        });
        
        // Add dataset management tab to tab change event
        document.querySelectorAll('#mlTabs button[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (event) {
                if (event.target.id === 'dataset-management-tab') {
                    loadDatasetsForManagement();
                }
            });
        });
    </script>
</body>
</html>